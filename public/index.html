<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple 整修機追蹤器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        apple: {
                            gray: '#86868b',
                            blue: '#007aff',
                            green: '#30d158',
                            red: '#ff453a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 頂部狀態列 -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                <div class="flex items-center space-x-3 text-sm">
                    <div class="flex items-center space-x-2">
                        <div id="statusDot" class="w-3 h-3 bg-red-400 rounded-full flex-shrink-0"></div>
                        <span id="statusText" class="text-gray-600">未追蹤</span>
                    </div>
                    <div class="text-gray-500">
                        追蹤規則: <span id="rulesCount" class="font-medium">0</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button id="startBtn" class="px-3 sm:px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md text-xs sm:text-sm font-medium transition-colors">
                        🚀 開始追蹤
                    </button>
                    <button id="stopBtn" class="px-3 sm:px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md text-xs sm:text-sm font-medium transition-colors hidden">
                        ⏹️ 停止追蹤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- 標題 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">🍎 Apple 整修機追蹤器</h1>
            <p class="text-gray-600">輕鬆追蹤您想要的 Apple 整修機產品</p>
        </div>

        <!-- 主要內容區域 -->
        <div class="grid lg:grid-cols-2 gap-6">
            <!-- 左側：追蹤規則設定 -->
            <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6 text-gray-900">📋 追蹤規則設定</h2>
                
                <!-- 新增規則表單 -->
                <form id="ruleForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">規則名稱</label>
                        <input type="text" id="ruleName" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" 
                               placeholder="例: 我想要的 MacBook Pro" required>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">產品類型</label>
                            <select id="productType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">不限</option>
                                <optgroup label="Mac">
                                    <option value="MacBook Air">MacBook Air</option>
                                    <option value="MacBook Pro">MacBook Pro</option>
                                    <option value="Mac Studio">Mac Studio</option>
                                    <option value="Mac mini">Mac mini</option>
                                    <option value="iMac">iMac</option>
                                </optgroup>
                                <optgroup label="iPad">
                                    <option value="iPad Pro">iPad Pro</option>
                                    <option value="iPad Air">iPad Air</option>
                                    <option value="iPad mini">iPad mini</option>
                                    <option value="iPad">iPad</option>
                                </optgroup>
                                <optgroup label="其他">
                                    <option value="Apple TV">Apple TV</option>
                                </optgroup>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">晶片類型</label>
                            <select id="chip" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">不限</option>
                                <option value="M2">M2</option>
                                <option value="M3">M3</option>
                                <option value="M4">M4</option>
                                <option value="M4 Pro">M4 Pro</option>
                                <option value="M4 Max">M4 Max</option>
                                <option value="M4 Ultra">M4 Ultra</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">最小記憶體</label>
                            <select id="minMemory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">不限</option>
                                <option value="8">8GB</option>
                                <option value="16">16GB</option>
                                <option value="32">32GB</option>
                                <option value="64">64GB</option>
                                <option value="128">128GB</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">顏色</label>
                            <select id="color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">不限</option>
                                <option value="銀色">銀色</option>
                                <option value="太空灰色">太空灰色</option>
                                <option value="太空黑色">太空黑色</option>
                                <option value="星光色">星光色</option>
                                <option value="午夜色">午夜色</option>
                                <option value="天藍色">天藍色</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">最高價格 (TWD)</label>
                        <input type="number" id="maxPrice" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" 
                               placeholder="例: 50000" min="0" step="1000">
                    </div>

                    <button type="submit" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-md font-medium transition-colors text-sm sm:text-base">
                        ➕ 新增規則
                    </button>
                </form>

                <!-- 規則列表 -->
                <div class="mt-6 sm:mt-8">
                    <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">目前規則</h3>
                    <div id="rulesList" class="space-y-3 max-h-64 sm:max-h-80 overflow-y-auto">
                        <div class="text-center text-gray-500 py-6 sm:py-8">
                            <div class="text-3xl sm:text-4xl mb-2">📝</div>
                            <p class="text-sm sm:text-base">尚未設定追蹤規則</p>
                            <p class="text-xs sm:text-sm mt-1">請填寫上方表單新增您的追蹤條件</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側：產品測試與結果 -->
            <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6 space-y-3 sm:space-y-0">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">🔍 產品測試</h2>
                    <button id="testBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-sm font-medium transition-colors self-start sm:self-auto">
                        🧪 測試爬取
                    </button>
                </div>
                
                <p class="text-gray-600 mb-4 text-sm sm:text-base">點擊按鈕測試產品爬取功能，查看目前可用的整修機產品</p>
                
                <div id="testResults" class="hidden">
                    <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">測試結果</h3>
                    <div id="productsList" class="space-y-3 sm:space-y-4 max-h-80 sm:max-h-96 overflow-y-auto">
                        <!-- 動態載入產品 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AppleTrackerUI {
            constructor() {
                this.config = { trackingRules: [] };
                this.currentUser = null;
                this.liffId = null; // 將從環境變數取得
                this.isLiffReady = false;
                this.productSpecs = {
                    'MacBook Air': {
                        chips: ['M2', 'M3', 'M4'],
                        memory: [8, 16, 24, 32],
                        colors: ['銀色', '太空灰色', '星光色', '午夜色']
                    },
                    'MacBook Pro': {
                        chips: ['M2 Pro', 'M2 Max', 'M3', 'M3 Pro', 'M3 Max', 'M4', 'M4 Pro', 'M4 Max'],
                        memory: [8, 16, 18, 32, 36, 64, 128],
                        colors: ['銀色', '太空灰色', '太空黑色']
                    },
                    'Mac Studio': {
                        chips: ['M2 Max', 'M2 Ultra', 'M4 Max', 'M4 Ultra'],
                        memory: [32, 64, 128, 192],
                        colors: ['銀色']
                    },
                    'Mac mini': {
                        chips: ['M2', 'M2 Pro', 'M4', 'M4 Pro'],
                        memory: [8, 16, 24, 32, 64],
                        colors: ['銀色']
                    },
                    'iPad': {
                        chips: ['M2', 'M4'],
                        memory: [8, 16, 32],
                        colors: ['銀色', '太空灰色', '天藍色', '粉紅色']
                    }
                };
                this.init();
            }

            async init() {
                await this.initLiff();
                if (this.isLiffReady && this.currentUser) {
                    await this.loadUserConfig();
                } else {
                    await this.loadConfig(); // 降級到一般模式
                }
                this.bindEvents();
                this.updateUI();
                this.checkStatus();
                
                setInterval(() => this.checkStatus(), 10000);
            }

            async initLiff() {
                try {
                    // 首先取得 LIFF ID
                    const response = await fetch('/api/liff-config');
                    const liffConfig = await response.json();
                    
                    if (!liffConfig.liffId) {
                        console.log('LIFF ID 未設定，使用一般模式');
                        return;
                    }

                    await liff.init({ liffId: liffConfig.liffId });
                    
                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        this.currentUser = {
                            userId: profile.userId,
                            displayName: profile.displayName,
                            pictureUrl: profile.pictureUrl
                        };
                        this.isLiffReady = true;
                        this.updateUserInfo();
                        console.log('LIFF 初始化成功，用戶:', this.currentUser.displayName);
                    } else {
                        console.log('用戶未登入 LINE');
                    }
                } catch (error) {
                    console.error('LIFF 初始化失敗:', error);
                    console.log('使用一般模式');
                }
            }

            bindEvents() {
                document.getElementById('ruleForm').addEventListener('submit', (e) => this.addRule(e));
                document.getElementById('startBtn').addEventListener('click', () => this.startTracking());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopTracking());
                document.getElementById('testBtn').addEventListener('click', () => this.testProducts());
                document.getElementById('productType').addEventListener('change', (e) => this.updateProductOptions(e.target.value));
            }

            async loadConfig() {
                try {
                    const response = await fetch('/api/config');
                    this.config = await response.json();
                } catch (error) {
                    console.error('載入配置失敗:', error);
                }
            }

            async loadUserConfig() {
                try {
                    const response = await fetch(`/api/users/${this.currentUser.userId}/config`);
                    this.config = await response.json();
                } catch (error) {
                    console.error('載入用戶配置失敗:', error);
                    this.config = { trackingRules: [] };
                }
            }

            async saveConfig() {
                try {
                    const apiUrl = this.isLiffReady && this.currentUser 
                        ? `/api/users/${this.currentUser.userId}/config`
                        : '/api/config';
                        
                    await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.config)
                    });
                } catch (error) {
                    console.error('儲存配置失敗:', error);
                    alert('儲存配置失敗');
                }
            }

            updateUserInfo() {
                if (!this.currentUser) return;
                
                // 在頁面顯示用戶資訊
                const statusBar = document.querySelector('.bg-white.shadow-sm.border-b .max-w-6xl > div');
                if (statusBar) {
                    const userInfo = document.createElement('div');
                    userInfo.className = 'flex items-center space-x-2 text-sm';
                    userInfo.innerHTML = `
                        <img src="${this.currentUser.pictureUrl}" alt="用戶頭像" class="w-6 h-6 rounded-full">
                        <span class="text-gray-600">歡迎，${this.currentUser.displayName}</span>
                    `;
                    statusBar.appendChild(userInfo);
                }
            }

            async checkStatus() {
                try {
                    const response = await fetch('/api/track/status');
                    const status = await response.json();
                    
                    const statusDot = document.getElementById('statusDot');
                    const statusText = document.getElementById('statusText');
                    
                    if (status.isTracking) {
                        statusDot.className = 'w-3 h-3 bg-green-400 rounded-full animate-pulse';
                        statusText.textContent = '追蹤中';
                        document.getElementById('startBtn').classList.add('hidden');
                        document.getElementById('stopBtn').classList.remove('hidden');
                    } else {
                        statusDot.className = 'w-3 h-3 bg-red-400 rounded-full';
                        statusText.textContent = '未追蹤';
                        document.getElementById('startBtn').classList.remove('hidden');
                        document.getElementById('stopBtn').classList.add('hidden');
                    }
                } catch (error) {
                    console.error('檢查狀態失敗:', error);
                }
            }

            addRule(e) {
                e.preventDefault();
                
                // 生成唯一的 ID
                const ruleId = 'rule_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const rule = {
                    id: ruleId,
                    name: document.getElementById('ruleName').value,
                    enabled: true,
                    filters: {
                        productType: document.getElementById('productType').value || undefined,
                        chip: document.getElementById('chip').value || undefined,
                        minMemory: document.getElementById('minMemory').value ? parseInt(document.getElementById('minMemory').value) : undefined,
                        color: document.getElementById('color').value || undefined,
                        maxPrice: document.getElementById('maxPrice').value ? parseInt(document.getElementById('maxPrice').value) : undefined
                    }
                };

                // 清理空值
                Object.keys(rule.filters).forEach(key => {
                    if (rule.filters[key] === undefined) {
                        delete rule.filters[key];
                    }
                });

                console.log('新增規則:', rule);
                
                this.config.trackingRules.push(rule);
                this.saveConfig();
                this.updateUI();
                
                document.getElementById('ruleForm').reset();
            }

            deleteRule(ruleId) {
                console.log('執行刪除規則:', ruleId);
                const originalLength = this.config.trackingRules.length;
                this.config.trackingRules = this.config.trackingRules.filter(rule => rule.id !== ruleId);
                
                if (this.config.trackingRules.length < originalLength) {
                    console.log('規則已刪除');
                    this.saveConfig();
                    this.updateUI();
                } else {
                    console.error('未找到要刪除的規則:', ruleId);
                }
            }

            toggleRule(ruleId) {
                console.log('執行切換規則:', ruleId);
                const rule = this.config.trackingRules.find(r => r.id === ruleId);
                if (rule) {
                    rule.enabled = !rule.enabled;
                    console.log('規則狀態已切換為:', rule.enabled);
                    this.saveConfig();
                    this.updateUI();
                } else {
                    console.error('未找到要切換的規則:', ruleId);
                }
            }

            updateUI() {
                document.getElementById('rulesCount').textContent = this.config.trackingRules.length;
                this.updateRulesList();
            }

            updateRulesList() {
                const container = document.getElementById('rulesList');
                
                if (this.config.trackingRules.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">📝</div>
                            <p>尚未設定追蹤規則</p>
                            <p class="text-sm">請填寫上方表單新增您的追蹤條件</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.config.trackingRules.map(rule => `
                    <div class="p-4 border rounded-lg ${rule.enabled ? 'border-blue-200 bg-blue-50' : 'border-gray-200 bg-gray-50'}" data-rule-id="${rule.id}">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-2 space-y-2 sm:space-y-0">
                            <h4 class="font-medium text-gray-900">${rule.name}</h4>
                            <div class="flex space-x-2 flex-shrink-0">
                                <button class="toggle-rule-btn px-3 py-1 text-xs rounded transition-colors ${rule.enabled ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}" 
                                        data-rule-id="${rule.id}">
                                    ${rule.enabled ? '停用' : '啟用'}
                                </button>
                                <button class="delete-rule-btn px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                        data-rule-id="${rule.id}">
                                    刪除
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 break-words">${this.formatFilters(rule.filters)}</p>
                    </div>
                `).join('');
                
                // 等待DOM更新後綁定事件
                setTimeout(() => {
                    console.log('綁定按鈕事件...');
                    
                    // 綁定切換按鈕事件
                    const toggleBtns = container.querySelectorAll('.toggle-rule-btn');
                    console.log('找到切換按鈕:', toggleBtns.length);
                    toggleBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // 確保獲取正確的元素和 rule-id
                            const target = e.currentTarget; // 使用 currentTarget 而不是 target
                            const ruleId = target.getAttribute('data-rule-id');
                            console.log('切換規則:', ruleId, 'target:', target);
                            
                            if (ruleId) {
                                this.toggleRule(ruleId);
                            } else {
                                console.error('無法獲取 rule-id');
                            }
                        });
                    });
                    
                    // 綁定刪除按鈕事件
                    const deleteBtns = container.querySelectorAll('.delete-rule-btn');
                    console.log('找到刪除按鈕:', deleteBtns.length);
                    deleteBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // 確保獲取正確的元素和 rule-id
                            const target = e.currentTarget; // 使用 currentTarget 而不是 target
                            const ruleId = target.getAttribute('data-rule-id');
                            console.log('刪除規則:', ruleId, 'target:', target);
                            
                            if (ruleId) {
                                if (confirm('確定要刪除這個追蹤規則嗎？')) {
                                    this.deleteRule(ruleId);
                                }
                            } else {
                                console.error('無法獲取 rule-id');
                            }
                        });
                    });
                }, 0);
            }

            formatFilters(filters) {
                const conditions = [];
                if (filters.productType) conditions.push(`產品: ${filters.productType}`);
                if (filters.chip) conditions.push(`晶片: ${filters.chip}`);
                if (filters.minMemory) conditions.push(`記憶體: ≥${filters.minMemory}GB`);
                if (filters.color) conditions.push(`顏色: ${filters.color}`);
                if (filters.maxPrice) conditions.push(`價格: ≤NT$${filters.maxPrice.toLocaleString()}`);
                
                return conditions.length > 0 ? conditions.join(' | ') : '無限制';
            }

            updateProductOptions(productType) {
                const chipSelect = document.getElementById('chip');
                const memorySelect = document.getElementById('minMemory');
                const colorSelect = document.getElementById('color');

                // 重置所有選項
                chipSelect.innerHTML = '<option value="">不限</option>';
                memorySelect.innerHTML = '<option value="">不限</option>';
                colorSelect.innerHTML = '<option value="">不限</option>';

                if (!productType || !this.productSpecs[productType]) {
                    // 如果沒選產品類型，顯示所有選項
                    ['M2', 'M2 Pro', 'M2 Max', 'M3', 'M3 Pro', 'M3 Max', 'M4', 'M4 Pro', 'M4 Max', 'M4 Ultra'].forEach(chip => {
                        chipSelect.innerHTML += `<option value="${chip}">${chip}</option>`;
                    });
                    [8, 16, 24, 32, 36, 64, 128, 192].forEach(memory => {
                        memorySelect.innerHTML += `<option value="${memory}">${memory}GB</option>`;
                    });
                    ['銀色', '太空灰色', '太空黑色', '星光色', '午夜色', '天藍色', '粉紅色'].forEach(color => {
                        colorSelect.innerHTML += `<option value="${color}">${color}</option>`;
                    });
                    return;
                }

                const specs = this.productSpecs[productType];

                // 更新晶片選項
                specs.chips.forEach(chip => {
                    chipSelect.innerHTML += `<option value="${chip}">${chip}</option>`;
                });

                // 更新記憶體選項
                specs.memory.forEach(memory => {
                    memorySelect.innerHTML += `<option value="${memory}">${memory}GB</option>`;
                });

                // 更新顏色選項
                specs.colors.forEach(color => {
                    colorSelect.innerHTML += `<option value="${color}">${color}</option>`;
                });
            }

            async startTracking() {
                try {
                    const response = await fetch('/api/track/start', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.checkStatus();
                    } else {
                        alert(result.error || '啟動失敗');
                    }
                } catch (error) {
                    console.error('啟動追蹤失敗:', error);
                    alert('啟動追蹤失敗');
                }
            }

            async stopTracking() {
                try {
                    const response = await fetch('/api/track/stop', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.checkStatus();
                    }
                } catch (error) {
                    console.error('停止追蹤失敗:', error);
                    alert('停止追蹤失敗');
                }
            }

            async testProducts() {
                const btn = document.getElementById('testBtn');
                const resultsDiv = document.getElementById('testResults');
                const productsDiv = document.getElementById('productsList');
                
                btn.disabled = true;
                btn.textContent = '🔄 測試中...';
                
                resultsDiv.classList.remove('hidden');
                productsDiv.innerHTML = '<div class="text-center py-8 text-gray-500">正在爬取產品資料，請稍候...</div>';
                
                try {
                    const response = await fetch('/api/products/test');
                    const result = await response.json();
                    
                    if (result.error) {
                        productsDiv.innerHTML = `<div class="text-center py-8 text-red-500">測試失敗: ${result.error}</div>`;
                        return;
                    }
                    
                    let htmlContent = `
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-medium text-blue-900">${result.message}</h4>
                        </div>
                    `;
                    
                    // 如果有規則結果，顯示每個規則的匹配情況
                    if (result.ruleResults && result.ruleResults.length > 0) {
                        htmlContent += '<div class="mb-6">';
                        htmlContent += '<h4 class="font-medium text-gray-900 mb-3">各規則匹配結果:</h4>';
                        
                        result.ruleResults.forEach(ruleResult => {
                            const matchText = ruleResult.matchCount > 0 ? 
                                `✅ 找到 ${ruleResult.matchCount} 個匹配產品` : 
                                '❌ 沒有匹配的產品';
                            
                            htmlContent += `
                                <div class="mb-3 p-3 border rounded-lg ${ruleResult.matchCount > 0 ? 'border-green-200 bg-green-50' : 'border-gray-200 bg-gray-50'}">
                                    <div class="font-medium">${ruleResult.ruleName}</div>
                                    <div class="text-sm text-gray-600">${matchText}</div>
                                </div>
                            `;
                        });
                        htmlContent += '</div>';
                    }
                    
                    // 顯示產品列表
                    const products = result.products || result.summary || [];
                    if (products.length === 0) {
                        htmlContent += '<div class="text-center py-8 text-gray-500">沒有找到符合條件的產品</div>';
                    } else {
                        htmlContent += '<h4 class="font-medium text-gray-900 mb-3">產品列表:</h4>';
                        htmlContent += products.map(product => `
                            <div class="flex flex-col sm:flex-row p-3 sm:p-4 border rounded-lg bg-gray-50 space-y-3 sm:space-y-0 mb-3">
                                <img src="${product.image || ''}" alt="${product.name}" 
                                     class="w-full h-32 sm:w-16 sm:h-16 rounded object-cover sm:mr-4 bg-gray-200 flex-shrink-0" 
                                     onerror="this.style.display='none'">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-gray-900 mb-1 text-sm sm:text-base break-words">
                                        ${product.url ? `<a href="${product.url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">${product.name}</a>` : product.name}
                                    </h4>
                                    <p class="text-base sm:text-lg font-semibold text-green-600 mb-1">${product.price || '價格未知'}</p>
                                    <p class="text-xs sm:text-sm text-gray-600 break-words">${this.formatSpecs(product.specs)}</p>
                                    ${product.url ? '<p class="text-xs text-blue-500 mt-1">🔗 點擊產品名稱查看詳情</p>' : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    productsDiv.innerHTML = htmlContent;
                    
                } catch (error) {
                    console.error('測試失敗:', error);
                    productsDiv.innerHTML = '<div class="text-center py-8 text-red-500">測試失敗，請檢查網路連線</div>';
                } finally {
                    btn.disabled = false;
                    btn.textContent = '🧪 測試爬取';
                }
            }

            formatSpecs(specs) {
                const specParts = [];
                if (specs.productType) specParts.push(specs.productType);
                if (specs.chip) specParts.push(specs.chip);
                if (specs.memory) specParts.push(specs.memory);
                if (specs.storage) specParts.push(specs.storage);
                if (specs.color) specParts.push(specs.color);
                
                return specParts.join(' | ') || '規格未知';
            }
        }

        const app = new AppleTrackerUI();
    </script>
</body>
</html>