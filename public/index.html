<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple æ•´ä¿®æ©Ÿè¿½è¹¤å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        apple: {
                            gray: '#86868b',
                            blue: '#007aff',
                            green: '#30d158',
                            red: '#ff453a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                <div class="flex items-center space-x-3 text-sm">
                    <div class="flex items-center space-x-2">
                        <div id="statusDot" class="w-3 h-3 bg-red-400 rounded-full flex-shrink-0"></div>
                        <span id="statusText" class="text-gray-600">æœªè¿½è¹¤</span>
                    </div>
                    <div class="text-gray-500">
                        è¿½è¹¤è¦å‰‡: <span id="rulesCount" class="font-medium">0</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button id="startBtn" class="px-3 sm:px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md text-xs sm:text-sm font-medium transition-colors">
                        ğŸš€ é–‹å§‹è¿½è¹¤
                    </button>
                    <button id="stopBtn" class="px-3 sm:px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md text-xs sm:text-sm font-medium transition-colors hidden">
                        â¹ï¸ åœæ­¢è¿½è¹¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-6">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ Apple æ•´ä¿®æ©Ÿè¿½è¹¤å™¨</h1>
            <p class="text-gray-600">è¼•é¬†è¿½è¹¤æ‚¨æƒ³è¦çš„ Apple æ•´ä¿®æ©Ÿç”¢å“</p>
        </div>

        <div class="grid lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6 text-gray-900">ğŸ“‹ è¿½è¹¤è¦å‰‡è¨­å®š</h2>
                
                <form id="ruleForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¦å‰‡åç¨±</label>
                        <input type="text" id="ruleName" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" 
                               placeholder="ä¾‹: æˆ‘æƒ³è¦çš„ MacBook Pro" required>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç”¢å“é¡å‹</label>
                            <select id="productType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">ä¸é™</option>
                                <optgroup label="Mac">
                                    <option value="MacBook Air">MacBook Air</option>
                                    <option value="MacBook Pro">MacBook Pro</option>
                                    <option value="Mac Studio">Mac Studio</option>
                                    <option value="Mac mini">Mac mini</option>
                                    <option value="iMac">iMac</option>
                                </optgroup>
                                <optgroup label="iPad">
                                    <option value="iPad Pro">iPad Pro</option>
                                    <option value="iPad Air">iPad Air</option>
                                    <option value="iPad mini">iPad mini</option>
                                    <option value="iPad">iPad</option>
                                </optgroup>
                                <optgroup label="å…¶ä»–">
                                    <option value="Apple TV">Apple TV</option>
                                </optgroup>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ™¶ç‰‡é¡å‹</label>
                            <select id="chip" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">ä¸é™</option>
                                <option value="M2">M2</option>
                                <option value="M3">M3</option>
                                <option value="M4">M4</option>
                                <option value="M4 Pro">M4 Pro</option>
                                <option value="M4 Max">M4 Max</option>
                                <option value="M4 Ultra">M4 Ultra</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è¨˜æ†¶é«”</label>
                            <select id="minMemory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">ä¸é™</option>
                                <option value="4">4GB</option>
                                <option value="8">8GB</option>
                                <option value="16">16GB</option>
                                <option value="18">18GB</option>
                                <option value="24">24GB</option>
                                <option value="32">32GB</option>
                                <option value="36">36GB</option>
                                <option value="64">64GB</option>
                                <option value="96">96GB</option>
                                <option value="128">128GB</option>
                                <option value="192">192GB</option>
                                <option value="768">768GB</option>
                                <option value="1500">1.5TB</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é¡è‰²</label>
                            <select id="color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">ä¸é™</option>
                                <option value="éŠ€è‰²">éŠ€è‰²</option>
                                <option value="å¤ªç©ºç°è‰²">å¤ªç©ºç°è‰²</option>
                                <option value="å¤ªç©ºé»‘è‰²">å¤ªç©ºé»‘è‰²</option>
                                <option value="æ˜Ÿå…‰è‰²">æ˜Ÿå…‰è‰²</option>
                                <option value="åˆå¤œè‰²">åˆå¤œè‰²</option>
                                <option value="å¤©è—è‰²">å¤©è—è‰²</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ€é«˜åƒ¹æ ¼ (TWD)</label>
                        <input type="number" id="maxPrice" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" 
                               placeholder="ä¾‹: 50000" min="0" step="1000">
                    </div>

                    <button type="submit" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-md font-medium transition-colors text-sm sm:text-base">
                        â• æ–°å¢è¦å‰‡
                    </button>
                </form>

                <div class="mt-6 sm:mt-8">
                    <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">ç›®å‰è¦å‰‡</h3>
                    <div id="rulesList" class="space-y-3 max-h-64 sm:max-h-80 overflow-y-auto">
                        <div class="text-center text-gray-500 py-6 sm:py-8">
                            <div class="text-3xl sm:text-4xl mb-2">ğŸ“</div>
                            <p class="text-sm sm:text-base">å°šæœªè¨­å®šè¿½è¹¤è¦å‰‡</p>
                            <p class="text-xs sm:text-sm mt-1">è«‹å¡«å¯«ä¸Šæ–¹è¡¨å–®æ–°å¢æ‚¨çš„è¿½è¹¤æ¢ä»¶</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6 space-y-3 sm:space-y-0">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">ğŸ” ç”¢å“æ¸¬è©¦</h2>
                    <button id="testBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-sm font-medium transition-colors self-start sm:self-auto">
                        ğŸ§ª æ¸¬è©¦çˆ¬å–
                    </button>
                </div>
                
                <p class="text-gray-600 mb-4 text-sm sm:text-base">é»æ“ŠæŒ‰éˆ•æ¸¬è©¦ç”¢å“çˆ¬å–åŠŸèƒ½ï¼ŒæŸ¥çœ‹ç›®å‰å¯ç”¨çš„æ•´ä¿®æ©Ÿç”¢å“</p>
                
                <div id="testResults" class="hidden">
                    <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">æ¸¬è©¦çµæœ</h3>
                    <div id="productsList" class="space-y-3 sm:space-y-4 max-h-80 sm:max-h-96 overflow-y-auto">
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-8 py-4 text-xs text-gray-400">
            <div id="versionInfo">v1.0.0</div>
        </footer>
    </div>

    <script>
        class AppleTrackerUI {
            constructor() {
                this.config = { trackingRules: [] };
                this.currentUser = null;
                this.liffId = null;
                this.isLiffReady = false;
                this.productSpecs = {
                    'MacBook Air': {
                        chips: ['M2', 'M3', 'M4'],
                        memory: [8, 16, 24, 32],
                        colors: ['éŠ€è‰²', 'å¤ªç©ºç°è‰²', 'æ˜Ÿå…‰è‰²', 'åˆå¤œè‰²']
                    },
                    'MacBook Pro': {
                        chips: ['M2 Pro', 'M2 Max', 'M3', 'M3 Pro', 'M3 Max', 'M4', 'M4 Pro', 'M4 Max'],
                        memory: [8, 16, 18, 24, 32, 36, 64, 128],
                        colors: ['éŠ€è‰²', 'å¤ªç©ºç°è‰²', 'å¤ªç©ºé»‘è‰²']
                    },
                    'Mac Studio': {
                        chips: ['M2 Max', 'M2 Ultra', 'M4 Max', 'M4 Ultra'],
                        memory: [32, 64, 128, 192],
                        colors: ['éŠ€è‰²']
                    },
                    'Mac mini': {
                        chips: ['M2', 'M2 Pro', 'M4', 'M4 Pro'],
                        memory: [8, 16, 24, 32, 64],
                        colors: ['éŠ€è‰²']
                    },
                    'iPad': {
                        chips: ['M2', 'M4'],
                        memory: [8, 16, 32],
                        colors: ['éŠ€è‰²', 'å¤ªç©ºç°è‰²', 'å¤©è—è‰²', 'ç²‰ç´…è‰²']
                    }
                };
                this.init();
            }

            async init() {
                // æª¢æŸ¥æ˜¯å¦å¾ LINE Login å›ä¾†
                const urlParams = new URLSearchParams(window.location.search);
                const userParam = urlParams.get('user');
                
                if (userParam) {
                    try {
                        this.currentUser = JSON.parse(decodeURIComponent(userParam));
                        this.isLiffReady = true;
                        await this.loadUserConfig();
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (error) {
                        console.error('è§£æç”¨æˆ¶è³‡è¨Šå¤±æ•—:', error);
                    }
                }

                if (!this.currentUser) {
                    await this.initLiff();
                    if (this.isLiffReady && this.currentUser) {
                        await this.loadUserConfig();
                    } else {
                        await this.checkLoginOptions();
                        return;
                    }
                }
                
                this.bindEvents();
                this.updateUI();
                this.updateUserInfo();
                this.loadVersion();
                this.checkStatus();
                
                setInterval(() => this.checkStatus(), 5 * 60 * 1000);
            }

            async checkLoginOptions() {
                const [liffConfig, lineLoginConfig] = await Promise.all([
                    fetch('/api/liff-config').then(r => r.json()),
                    fetch('/api/line-login-config').then(r => r.json())
                ]);

                const isInLineApp = this.isInLineApp();

                if (isInLineApp && liffConfig.liffId) {
                    this.showLiffPrompt();
                } else if (lineLoginConfig.channelId) {
                    this.showLineLoginOption();
                } else {
                    this.showNoLoginConfig();
                }
            }

            isInLineApp() {
                const userAgent = navigator.userAgent.toLowerCase();
                return userAgent.includes('line/');
            }

            showLiffPrompt() {
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
                        <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-6 text-center">
                            <div class="mb-6">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM10 17l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                </div>
                                <h1 class="text-2xl font-bold text-gray-900 mb-2">è«‹é€é LINE é–‹å•Ÿ</h1>
                                <p class="text-gray-600 mb-6">
                                    æ­¤ç¶²é éœ€è¦é€é LINE é–‹å•Ÿæ‰èƒ½è‡ªå‹•è­˜åˆ¥æ‚¨çš„èº«ä»½ä¸¦ç®¡ç†å€‹äººè¿½è¹¤è¦å‰‡ã€‚
                                </p>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="text-left bg-gray-50 rounded-lg p-4">
                                    <h3 class="font-semibold text-gray-900 mb-2">ğŸ“± ä½¿ç”¨æ­¥é©Ÿï¼š</h3>
                                    <ol class="text-sm text-gray-700 space-y-1">
                                        <li>1. åŠ  LINE Bot ç‚ºå¥½å‹</li>
                                        <li>2. å‚³é€ã€Œæ–°å¢è¦å‰‡ã€æŒ‡ä»¤</li>
                                        <li>3. é»é¸ Bot å›è¦†çš„é€£çµ</li>
                                        <li>4. è‡ªå‹•è­˜åˆ¥èº«ä»½ä¸¦è¨­å®šè¦å‰‡</li>
                                    </ol>
                                </div>
                                
                                <button onclick="window.location.reload()" 
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                    ğŸ”„ é‡æ–°è¼‰å…¥
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            showLineLoginOption() {
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-100 flex items-center justify-center px-4">
                        <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-6 text-center">
                            <div class="mb-6">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM10 17l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                </div>
                                <h1 class="text-2xl font-bold text-gray-900 mb-2">ğŸ Apple æ•´ä¿®æ©Ÿè¿½è¹¤å™¨</h1>
                                <p class="text-gray-600 mb-6">
                                    è«‹é€é LINE ç™»å…¥ä»¥è¨­å®šæ‚¨çš„å€‹äººè¿½è¹¤è¦å‰‡
                                </p>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="text-left bg-gray-50 rounded-lg p-4">
                                    <h3 class="font-semibold text-gray-900 mb-2">âœ¨ åŠŸèƒ½ç‰¹è‰²ï¼š</h3>
                                    <ul class="text-sm text-gray-700 space-y-1">
                                        <li>â€¢ è‡ªå‹•è¿½è¹¤ Apple æ•´ä¿®æ©Ÿç”¢å“</li>
                                        <li>â€¢ å€‹äººåŒ–çš„è¿½è¹¤æ¢ä»¶è¨­å®š</li>
                                        <li>â€¢ LINE å³æ™‚é€šçŸ¥æ–°ç”¢å“</li>
                                        <li>â€¢ åƒ¹æ ¼ã€è¦æ ¼æ¢ä»¶ç¯©é¸</li>
                                    </ul>
                                </div>
                                
                                <a href="/auth/line" 
                                   class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-4 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2 block no-underline">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63.349 0 .631.285.631.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.629 0 .344-.281.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                                    </svg>
                                    <span>é€é LINE ç™»å…¥</span>
                                </a>
                                
                                <p class="text-xs text-gray-500">
                                    ç™»å…¥å¾Œå³å¯è¨­å®šå€‹äººè¿½è¹¤è¦å‰‡ä¸¦æ¥æ”¶é€šçŸ¥
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }

            showNoLoginConfig() {
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-red-50 to-orange-100 flex items-center justify-center px-4">
                        <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-6 text-center">
                            <div class="mb-6">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM13 17h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                    </svg>
                                </div>
                                <h1 class="text-2xl font-bold text-gray-900 mb-2">é…ç½®æœªå®Œæˆ</h1>
                                <p class="text-gray-600 mb-6">
                                    ç³»çµ±å°šæœªé…ç½® LINE ç™»å…¥åŠŸèƒ½ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡è¨­å®šç›¸é—œåƒæ•¸ã€‚
                                </p>
                            </div>
                            
                            <button onclick="window.location.reload()" 
                                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                ğŸ”„ é‡æ–°è¼‰å…¥
                            </button>
                        </div>
                    </div>
                `;
            }

            async initLiff() {
                try {
                    const response = await fetch('/api/liff-config');
                    const liffConfig = await response.json();
                    
                    if (!liffConfig.liffId) {
                            return;
                    }

                    await liff.init({ liffId: liffConfig.liffId });
                    
                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        this.currentUser = {
                            userId: profile.userId,
                            displayName: profile.displayName,
                            pictureUrl: profile.pictureUrl
                        };
                        this.isLiffReady = true;
                        this.updateUserInfo();
                    } else {
                    }
                } catch (error) {
                    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                }
            }

            bindEvents() {
                document.getElementById('ruleForm').addEventListener('submit', (e) => this.addRule(e));
                document.getElementById('startBtn').addEventListener('click', () => this.startTracking());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopTracking());
                document.getElementById('testBtn').addEventListener('click', () => this.testProducts());
                document.getElementById('productType').addEventListener('change', (e) => this.updateProductOptions(e.target.value));
            }

            async loadConfig() {
                this.config = { trackingRules: [] };
            }

            async loadUserConfig() {
                try {
                    const response = await fetch(`/api/users/${this.currentUser.userId}/config`);
                    this.config = await response.json();
                } catch (error) {
                    console.error('è¼‰å…¥ç”¨æˆ¶é…ç½®å¤±æ•—:', error);
                    this.config = { trackingRules: [] };
                }
            }

            async saveConfig() {
                try {
                    if (!this.isLiffReady || !this.currentUser) {
                        throw new Error('è«‹é€é LINE ç™»å…¥å¾Œå†è¨­å®šè¦å‰‡');
                    }
                    
                    const apiUrl = `/api/users/${this.currentUser.userId}/config`;
                        
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.config)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                } catch (error) {
                    console.error('å„²å­˜é…ç½®å¤±æ•—:', error);
                    alert('å„²å­˜é…ç½®å¤±æ•—: ' + error.message);
                }
            }

            updateUserInfo() {
                if (!this.currentUser) return;
                
                const existingUserInfo = document.querySelector('.user-info');
                if (existingUserInfo) return;
                
                const statusBar = document.querySelector('.bg-white.shadow-sm.border-b .max-w-6xl > div');
                if (statusBar) {
                    const userInfo = document.createElement('div');
                    userInfo.className = 'flex items-center space-x-2 text-sm user-info';
                    userInfo.innerHTML = `
                        <img src="${this.currentUser.pictureUrl}" alt="ç”¨æˆ¶é ­åƒ" class="w-6 h-6 rounded-full">
                        <span class="text-gray-600">æ­¡è¿ï¼Œ${this.currentUser.displayName}</span>
                    `;
                    statusBar.appendChild(userInfo);
                }
            }

            async loadVersion() {
                try {
                    const response = await fetch('/api/version');
                    const versionData = await response.json();
                    document.getElementById('versionInfo').textContent = `v${versionData.version}`;
                } catch (error) {
                    console.error('è¼‰å…¥ç‰ˆæœ¬è³‡è¨Šå¤±æ•—:', error);
                }
            }

            async checkStatus() {
                try {
                    const response = await fetch('/api/track/status');
                    const status = await response.json();
                    
                    const statusDot = document.getElementById('statusDot');
                    const statusText = document.getElementById('statusText');
                    
                    if (status.isTracking) {
                        statusDot.className = 'w-3 h-3 bg-green-400 rounded-full animate-pulse';
                        statusText.textContent = status.autoRestarted ? 'è¿½è¹¤ä¸­ (è‡ªå‹•é‡å•Ÿ)' : 'è¿½è¹¤ä¸­';
                        document.getElementById('startBtn').classList.add('hidden');
                        document.getElementById('stopBtn').classList.remove('hidden');
                    } else {
                        statusDot.className = 'w-3 h-3 bg-red-400 rounded-full';
                        statusText.textContent = 'æœªè¿½è¹¤';
                        document.getElementById('startBtn').classList.remove('hidden');
                        document.getElementById('stopBtn').classList.add('hidden');
                    }
                } catch (error) {
                    console.error('æª¢æŸ¥ç‹€æ…‹å¤±æ•—:', error);
                }
            }

            async addRule(e) {
                e.preventDefault();
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                
                try {
                    // è¨­ç½®loadingç‹€æ…‹
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'ğŸ”„ æ–°å¢ä¸­...';
                    submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
                    
                    if (!this.config.trackingRules) {
                        this.config.trackingRules = [];
                    }
                    
                    const ruleName = document.getElementById('ruleName').value.trim();
                    if (!ruleName) {
                        alert('è«‹è¼¸å…¥è¦å‰‡åç¨±');
                        return;
                    }
                    
                    const ruleId = 'rule_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    const rule = {
                        id: ruleId,
                        name: ruleName,
                        enabled: true,
                        filters: {
                            productType: document.getElementById('productType').value || undefined,
                            chip: document.getElementById('chip').value || undefined,
                            minMemory: document.getElementById('minMemory').value ? parseInt(document.getElementById('minMemory').value) : undefined,
                            color: document.getElementById('color').value || undefined,
                            maxPrice: document.getElementById('maxPrice').value ? parseInt(document.getElementById('maxPrice').value) : undefined
                        }
                    };

                    Object.keys(rule.filters).forEach(key => {
                        if (rule.filters[key] === undefined) {
                            delete rule.filters[key];
                        }
                    });

                    
                    this.config.trackingRules.push(rule);
                    await this.saveConfig();
                    this.updateUI();
                    
                    document.getElementById('ruleForm').reset();
                    alert('è¦å‰‡æ–°å¢æˆåŠŸï¼');
                } catch (error) {
                    console.error('æ–°å¢è¦å‰‡å¤±æ•—:', error);
                    alert('æ–°å¢è¦å‰‡å¤±æ•—: ' + error.message);
                } finally {
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            }

            async deleteRule(ruleId, buttonElement = null) {
                
                if (!this.isLiffReady || !this.currentUser) {
                    alert('è«‹é€é LINE ç™»å…¥å¾Œå†åˆªé™¤è¦å‰‡');
                    return;
                }

                // è¨­ç½®loadingç‹€æ…‹
                let originalText = '';
                if (buttonElement) {
                    originalText = buttonElement.textContent;
                    buttonElement.disabled = true;
                    buttonElement.textContent = 'ğŸ”„ åˆªé™¤ä¸­...';
                    buttonElement.classList.add('opacity-75', 'cursor-not-allowed');
                }

                try {
                    const response = await fetch(`/api/users/${this.currentUser.userId}/rules/${ruleId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    this.config.trackingRules = this.config.trackingRules.filter(rule => rule.id !== ruleId);
                    this.updateUI();
                    
                    alert('è¦å‰‡å·²æˆåŠŸåˆªé™¤ï¼');
                } catch (error) {
                    console.error('åˆªé™¤è¦å‰‡å¤±æ•—:', error);
                    alert('åˆªé™¤è¦å‰‡å¤±æ•—: ' + error.message);
                }
            }

            async toggleRule(ruleId) {
                console.log('åŸ·è¡Œåˆ‡æ›è¦å‰‡:', ruleId);
                const rule = this.config.trackingRules.find(r => r.id === ruleId);
                if (rule) {
                    rule.enabled = !rule.enabled;
                    console.log('è¦å‰‡ç‹€æ…‹å·²åˆ‡æ›ç‚º:', rule.enabled);
                    await this.saveConfig();
                    this.updateUI();
                } else {
                    console.error('æœªæ‰¾åˆ°è¦åˆ‡æ›çš„è¦å‰‡:', ruleId);
                }
            }

            updateUI() {
                document.getElementById('rulesCount').textContent = this.config.trackingRules.length;
                this.updateRulesList();
            }

            updateRulesList() {
                const container = document.getElementById('rulesList');
                
                if (this.config.trackingRules.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">ğŸ“</div>
                            <p>å°šæœªè¨­å®šè¿½è¹¤è¦å‰‡</p>
                            <p class="text-sm">è«‹å¡«å¯«ä¸Šæ–¹è¡¨å–®æ–°å¢æ‚¨çš„è¿½è¹¤æ¢ä»¶</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.config.trackingRules.map(rule => `
                    <div class="p-4 border rounded-lg ${rule.enabled ? 'border-blue-200 bg-blue-50' : 'border-gray-200 bg-gray-50'}" data-rule-id="${rule.id}">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-2 space-y-2 sm:space-y-0">
                            <h4 class="font-medium text-gray-900">${rule.name}</h4>
                            <div class="flex space-x-2 flex-shrink-0">
                                <button class="toggle-rule-btn px-3 py-1 text-xs rounded transition-colors ${rule.enabled ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}" 
                                        data-rule-id="${rule.id}">
                                    ${rule.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}
                                </button>
                                <button class="delete-rule-btn px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                        data-rule-id="${rule.id}">
                                    åˆªé™¤
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 break-words">${this.formatFilters(rule.filters)}</p>
                    </div>
                `).join('');
                
                setTimeout(() => {
                    
                    const toggleBtns = container.querySelectorAll('.toggle-rule-btn');
                    toggleBtns.forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const target = e.currentTarget;
                            const ruleId = target.getAttribute('data-rule-id');
                            
                            if (ruleId) {
                                await this.toggleRule(ruleId);
                            } else {
                                console.error('ç„¡æ³•ç²å– rule-id');
                            }
                        });
                    });
                    
                    const deleteBtns = container.querySelectorAll('.delete-rule-btn');
                    deleteBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const target = e.currentTarget;
                            const ruleId = target.getAttribute('data-rule-id');
                            
                            if (ruleId) {
                                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¿½è¹¤è¦å‰‡å—ï¼Ÿ')) {
                                    this.deleteRule(ruleId, target);
                                }
                            } else {
                                console.error('ç„¡æ³•ç²å– rule-id');
                            }
                        });
                    });
                }, 0);
            }

            formatFilters(filters) {
                const conditions = [];
                if (filters.productType) conditions.push(`ç”¢å“: ${filters.productType}`);
                if (filters.chip) conditions.push(`æ™¶ç‰‡: ${filters.chip}`);
                if (filters.minMemory) conditions.push(`è¨˜æ†¶é«”: â‰¥${filters.minMemory}GB`);
                if (filters.color) conditions.push(`é¡è‰²: ${filters.color}`);
                if (filters.maxPrice) conditions.push(`åƒ¹æ ¼: â‰¤NT$${filters.maxPrice.toLocaleString()}`);
                
                return conditions.length > 0 ? conditions.join(' | ') : 'ç„¡é™åˆ¶';
            }

            updateProductOptions(productType) {
                const chipSelect = document.getElementById('chip');
                const memorySelect = document.getElementById('minMemory');
                const colorSelect = document.getElementById('color');

                chipSelect.innerHTML = '<option value="">ä¸é™</option>';
                memorySelect.innerHTML = '<option value="">ä¸é™</option>';
                colorSelect.innerHTML = '<option value="">ä¸é™</option>';

                if (!productType || !this.productSpecs[productType]) {
                    ['M2', 'M2 Pro', 'M2 Max', 'M3', 'M3 Pro', 'M3 Max', 'M4', 'M4 Pro', 'M4 Max', 'M4 Ultra'].forEach(chip => {
                        chipSelect.innerHTML += `<option value="${chip}">${chip}</option>`;
                    });
                    [8, 16, 24, 32, 36, 64, 128, 192].forEach(memory => {
                        memorySelect.innerHTML += `<option value="${memory}">${memory}GB</option>`;
                    });
                    ['éŠ€è‰²', 'å¤ªç©ºç°è‰²', 'å¤ªç©ºé»‘è‰²', 'æ˜Ÿå…‰è‰²', 'åˆå¤œè‰²', 'å¤©è—è‰²', 'ç²‰ç´…è‰²'].forEach(color => {
                        colorSelect.innerHTML += `<option value="${color}">${color}</option>`;
                    });
                    return;
                }

                const specs = this.productSpecs[productType];

                specs.chips.forEach(chip => {
                    chipSelect.innerHTML += `<option value="${chip}">${chip}</option>`;
                });

                specs.memory.forEach(memory => {
                    memorySelect.innerHTML += `<option value="${memory}">${memory}GB</option>`;
                });

                specs.colors.forEach(color => {
                    colorSelect.innerHTML += `<option value="${color}">${color}</option>`;
                });
            }

            async startTracking() {
                const btn = document.getElementById('startBtn');
                const originalText = btn.textContent;
                
                try {
                    btn.disabled = true;
                    btn.textContent = 'ğŸ”„ å•Ÿå‹•ä¸­...';
                    btn.classList.add('opacity-75', 'cursor-not-allowed');
                    
                    const response = await fetch('/api/track/start', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.checkStatus();
                    } else {
                        alert(result.error || 'å•Ÿå‹•å¤±æ•—');
                    }
                } catch (error) {
                    console.error('å•Ÿå‹•è¿½è¹¤å¤±æ•—:', error);
                    alert('å•Ÿå‹•è¿½è¹¤å¤±æ•—');
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            }

            async stopTracking() {
                const btn = document.getElementById('stopBtn');
                const originalText = btn.textContent;
                
                try {
                    btn.disabled = true;
                    btn.textContent = 'ğŸ”„ åœæ­¢ä¸­...';
                    btn.classList.add('opacity-75', 'cursor-not-allowed');
                    
                    const response = await fetch('/api/track/stop', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.checkStatus();
                    }
                } catch (error) {
                    console.error('åœæ­¢è¿½è¹¤å¤±æ•—:', error);
                    alert('åœæ­¢è¿½è¹¤å¤±æ•—');
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            }

            async testProducts() {
                const btn = document.getElementById('testBtn');
                const resultsDiv = document.getElementById('testResults');
                const productsDiv = document.getElementById('productsList');
                
                btn.disabled = true;
                btn.textContent = 'ğŸ”„ æ¸¬è©¦ä¸­...';
                
                resultsDiv.classList.remove('hidden');
                productsDiv.innerHTML = '<div class="text-center py-8 text-gray-500">æ­£åœ¨çˆ¬å–ç”¢å“è³‡æ–™ï¼Œè«‹ç¨å€™...</div>';
                
                try {
                    const response = await fetch('/api/products/test');
                    const result = await response.json();
                    
                    if (result.error) {
                        productsDiv.innerHTML = `<div class="text-center py-8 text-red-500">æ¸¬è©¦å¤±æ•—: ${result.error}</div>`;
                        return;
                    }
                    
                    let htmlContent = `
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-medium text-blue-900">${result.message}</h4>
                        </div>
                    `;
                    
                    if (result.ruleResults && result.ruleResults.length > 0) {
                        htmlContent += '<div class="mb-6">';
                        htmlContent += '<h4 class="font-medium text-gray-900 mb-3">å„è¦å‰‡åŒ¹é…çµæœ:</h4>';
                        
                        result.ruleResults.forEach(ruleResult => {
                            const matchText = ruleResult.matchCount > 0 ? 
                                `âœ… æ‰¾åˆ° ${ruleResult.matchCount} å€‹åŒ¹é…ç”¢å“` : 
                                'âŒ æ²’æœ‰åŒ¹é…çš„ç”¢å“';
                            
                            htmlContent += `
                                <div class="mb-3 p-3 border rounded-lg ${ruleResult.matchCount > 0 ? 'border-green-200 bg-green-50' : 'border-gray-200 bg-gray-50'}">
                                    <div class="font-medium">${ruleResult.ruleName}</div>
                                    <div class="text-sm text-gray-600">${matchText}</div>
                                </div>
                            `;
                        });
                        htmlContent += '</div>';
                    }
                    
                    const products = result.products || result.summary || [];
                    if (products.length === 0) {
                        htmlContent += '<div class="text-center py-8 text-gray-500">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç”¢å“</div>';
                    } else {
                        htmlContent += '<h4 class="font-medium text-gray-900 mb-3">ç”¢å“åˆ—è¡¨:</h4>';
                        htmlContent += products.map(product => `
                            <div class="flex flex-col sm:flex-row p-3 sm:p-4 border rounded-lg bg-gray-50 space-y-3 sm:space-y-0 mb-3">
                                <img src="${product.image || ''}" alt="${product.name}" 
                                     class="w-full h-32 sm:w-16 sm:h-16 rounded object-cover sm:mr-4 bg-gray-200 flex-shrink-0" 
                                     onerror="this.style.display='none'">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-gray-900 mb-1 text-sm sm:text-base break-words">
                                        ${product.url ? `<a href="${product.url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">${product.name}</a>` : product.name}
                                    </h4>
                                    <p class="text-base sm:text-lg font-semibold text-green-600 mb-1">${product.price || 'åƒ¹æ ¼æœªçŸ¥'}</p>
                                    <p class="text-xs sm:text-sm text-gray-600 break-words">${this.formatSpecs(product.specs)}</p>
                                    ${product.url ? '<p class="text-xs text-blue-500 mt-1">ğŸ”— é»æ“Šç”¢å“åç¨±æŸ¥çœ‹è©³æƒ…</p>' : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    productsDiv.innerHTML = htmlContent;
                    
                } catch (error) {
                    console.error('æ¸¬è©¦å¤±æ•—:', error);
                    productsDiv.innerHTML = '<div class="text-center py-8 text-red-500">æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>';
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ§ª æ¸¬è©¦çˆ¬å–';
                }
            }

            formatSpecs(specs) {
                const specParts = [];
                if (specs.productType) specParts.push(specs.productType);
                if (specs.chip) specParts.push(specs.chip);
                if (specs.memory) specParts.push(specs.memory);
                if (specs.storage) specParts.push(specs.storage);
                if (specs.color) specParts.push(specs.color);
                
                return specParts.join(' | ') || 'è¦æ ¼æœªçŸ¥';
            }
        }

        const app = new AppleTrackerUI();
    </script>
</body>
</html>