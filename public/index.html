<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple æ•´ä¿®æ©Ÿè¿½è¹¤å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        apple: {
                            gray: '#86868b',
                            blue: '#007aff',
                            green: '#30d158',
                            red: '#ff453a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é ‚éƒ¨ç‹€æ…‹åˆ— -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                <div class="flex items-center space-x-3 text-sm">
                    <div class="flex items-center space-x-2">
                        <div id="statusDot" class="w-3 h-3 bg-red-400 rounded-full flex-shrink-0"></div>
                        <span id="statusText" class="text-gray-600">æœªè¿½è¹¤</span>
                    </div>
                    <div class="text-gray-500">
                        è¿½è¹¤è¦å‰‡: <span id="rulesCount" class="font-medium">0</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button id="startBtn" class="px-3 sm:px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md text-xs sm:text-sm font-medium transition-colors">
                        ğŸš€ é–‹å§‹è¿½è¹¤
                    </button>
                    <button id="stopBtn" class="px-3 sm:px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md text-xs sm:text-sm font-medium transition-colors hidden">
                        â¹ï¸ åœæ­¢è¿½è¹¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ Apple æ•´ä¿®æ©Ÿè¿½è¹¤å™¨</h1>
            <p class="text-gray-600">è¼•é¬†è¿½è¹¤æ‚¨æƒ³è¦çš„ Apple æ•´ä¿®æ©Ÿç”¢å“</p>
        </div>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="grid lg:grid-cols-2 gap-6">
            <!-- å·¦å´ï¼šè¿½è¹¤è¦å‰‡è¨­å®š -->
            <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6 text-gray-900">ğŸ“‹ è¿½è¹¤è¦å‰‡è¨­å®š</h2>
                
                <!-- æ–°å¢è¦å‰‡è¡¨å–® -->
                <form id="ruleForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¦å‰‡åç¨±</label>
                        <input type="text" id="ruleName" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" 
                               placeholder="ä¾‹: æˆ‘æƒ³è¦çš„ MacBook Pro" required>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç”¢å“é¡å‹</label>
                            <select id="productType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">ä¸é™</option>
                                <optgroup label="Mac">
                                    <option value="MacBook Air">MacBook Air</option>
                                    <option value="MacBook Pro">MacBook Pro</option>
                                    <option value="Mac Studio">Mac Studio</option>
                                    <option value="Mac mini">Mac mini</option>
                                    <option value="iMac">iMac</option>
                                </optgroup>
                                <optgroup label="iPad">
                                    <option value="iPad Pro">iPad Pro</option>
                                    <option value="iPad Air">iPad Air</option>
                                    <option value="iPad mini">iPad mini</option>
                                    <option value="iPad">iPad</option>
                                </optgroup>
                                <optgroup label="å…¶ä»–">
                                    <option value="Apple TV">Apple TV</option>
                                </optgroup>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ™¶ç‰‡é¡å‹</label>
                            <select id="chip" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">ä¸é™</option>
                                <option value="M2">M2</option>
                                <option value="M3">M3</option>
                                <option value="M4">M4</option>
                                <option value="M4 Pro">M4 Pro</option>
                                <option value="M4 Max">M4 Max</option>
                                <option value="M4 Ultra">M4 Ultra</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æœ€å°è¨˜æ†¶é«”</label>
                            <select id="minMemory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">ä¸é™</option>
                                <option value="8">8GB</option>
                                <option value="16">16GB</option>
                                <option value="32">32GB</option>
                                <option value="64">64GB</option>
                                <option value="128">128GB</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é¡è‰²</label>
                            <select id="color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                <option value="">ä¸é™</option>
                                <option value="éŠ€è‰²">éŠ€è‰²</option>
                                <option value="å¤ªç©ºç°è‰²">å¤ªç©ºç°è‰²</option>
                                <option value="å¤ªç©ºé»‘è‰²">å¤ªç©ºé»‘è‰²</option>
                                <option value="æ˜Ÿå…‰è‰²">æ˜Ÿå…‰è‰²</option>
                                <option value="åˆå¤œè‰²">åˆå¤œè‰²</option>
                                <option value="å¤©è—è‰²">å¤©è—è‰²</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ€é«˜åƒ¹æ ¼ (TWD)</label>
                        <input type="number" id="maxPrice" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" 
                               placeholder="ä¾‹: 50000" min="0" step="1000">
                    </div>

                    <button type="submit" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-md font-medium transition-colors text-sm sm:text-base">
                        â• æ–°å¢è¦å‰‡
                    </button>
                </form>

                <!-- è¦å‰‡åˆ—è¡¨ -->
                <div class="mt-6 sm:mt-8">
                    <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">ç›®å‰è¦å‰‡</h3>
                    <div id="rulesList" class="space-y-3 max-h-64 sm:max-h-80 overflow-y-auto">
                        <div class="text-center text-gray-500 py-6 sm:py-8">
                            <div class="text-3xl sm:text-4xl mb-2">ğŸ“</div>
                            <p class="text-sm sm:text-base">å°šæœªè¨­å®šè¿½è¹¤è¦å‰‡</p>
                            <p class="text-xs sm:text-sm mt-1">è«‹å¡«å¯«ä¸Šæ–¹è¡¨å–®æ–°å¢æ‚¨çš„è¿½è¹¤æ¢ä»¶</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šç”¢å“æ¸¬è©¦èˆ‡çµæœ -->
            <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6 space-y-3 sm:space-y-0">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">ğŸ” ç”¢å“æ¸¬è©¦</h2>
                    <button id="testBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-sm font-medium transition-colors self-start sm:self-auto">
                        ğŸ§ª æ¸¬è©¦çˆ¬å–
                    </button>
                </div>
                
                <p class="text-gray-600 mb-4 text-sm sm:text-base">é»æ“ŠæŒ‰éˆ•æ¸¬è©¦ç”¢å“çˆ¬å–åŠŸèƒ½ï¼ŒæŸ¥çœ‹ç›®å‰å¯ç”¨çš„æ•´ä¿®æ©Ÿç”¢å“</p>
                
                <div id="testResults" class="hidden">
                    <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">æ¸¬è©¦çµæœ</h3>
                    <div id="productsList" class="space-y-3 sm:space-y-4 max-h-80 sm:max-h-96 overflow-y-auto">
                        <!-- å‹•æ…‹è¼‰å…¥ç”¢å“ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AppleTrackerUI {
            constructor() {
                this.config = { trackingRules: [] };
                this.currentUser = null;
                this.liffId = null; // å°‡å¾ç’°å¢ƒè®Šæ•¸å–å¾—
                this.isLiffReady = false;
                this.productSpecs = {
                    'MacBook Air': {
                        chips: ['M2', 'M3', 'M4'],
                        memory: [8, 16, 24, 32],
                        colors: ['éŠ€è‰²', 'å¤ªç©ºç°è‰²', 'æ˜Ÿå…‰è‰²', 'åˆå¤œè‰²']
                    },
                    'MacBook Pro': {
                        chips: ['M2 Pro', 'M2 Max', 'M3', 'M3 Pro', 'M3 Max', 'M4', 'M4 Pro', 'M4 Max'],
                        memory: [8, 16, 18, 32, 36, 64, 128],
                        colors: ['éŠ€è‰²', 'å¤ªç©ºç°è‰²', 'å¤ªç©ºé»‘è‰²']
                    },
                    'Mac Studio': {
                        chips: ['M2 Max', 'M2 Ultra', 'M4 Max', 'M4 Ultra'],
                        memory: [32, 64, 128, 192],
                        colors: ['éŠ€è‰²']
                    },
                    'Mac mini': {
                        chips: ['M2', 'M2 Pro', 'M4', 'M4 Pro'],
                        memory: [8, 16, 24, 32, 64],
                        colors: ['éŠ€è‰²']
                    },
                    'iPad': {
                        chips: ['M2', 'M4'],
                        memory: [8, 16, 32],
                        colors: ['éŠ€è‰²', 'å¤ªç©ºç°è‰²', 'å¤©è—è‰²', 'ç²‰ç´…è‰²']
                    }
                };
                this.init();
            }

            async init() {
                await this.initLiff();
                if (this.isLiffReady && this.currentUser) {
                    await this.loadUserConfig();
                } else {
                    await this.loadConfig(); // é™ç´šåˆ°ä¸€èˆ¬æ¨¡å¼
                }
                this.bindEvents();
                this.updateUI();
                this.checkStatus();
                
                setInterval(() => this.checkStatus(), 10000);
            }

            async initLiff() {
                try {
                    // é¦–å…ˆå–å¾— LIFF ID
                    const response = await fetch('/api/liff-config');
                    const liffConfig = await response.json();
                    
                    if (!liffConfig.liffId) {
                        console.log('LIFF ID æœªè¨­å®šï¼Œä½¿ç”¨ä¸€èˆ¬æ¨¡å¼');
                        return;
                    }

                    await liff.init({ liffId: liffConfig.liffId });
                    
                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        this.currentUser = {
                            userId: profile.userId,
                            displayName: profile.displayName,
                            pictureUrl: profile.pictureUrl
                        };
                        this.isLiffReady = true;
                        this.updateUserInfo();
                        console.log('LIFF åˆå§‹åŒ–æˆåŠŸï¼Œç”¨æˆ¶:', this.currentUser.displayName);
                    } else {
                        console.log('ç”¨æˆ¶æœªç™»å…¥ LINE');
                    }
                } catch (error) {
                    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                    console.log('ä½¿ç”¨ä¸€èˆ¬æ¨¡å¼');
                }
            }

            bindEvents() {
                document.getElementById('ruleForm').addEventListener('submit', (e) => this.addRule(e));
                document.getElementById('startBtn').addEventListener('click', () => this.startTracking());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopTracking());
                document.getElementById('testBtn').addEventListener('click', () => this.testProducts());
                document.getElementById('productType').addEventListener('change', (e) => this.updateProductOptions(e.target.value));
            }

            async loadConfig() {
                try {
                    const response = await fetch('/api/config');
                    this.config = await response.json();
                } catch (error) {
                    console.error('è¼‰å…¥é…ç½®å¤±æ•—:', error);
                }
            }

            async loadUserConfig() {
                try {
                    const response = await fetch(`/api/users/${this.currentUser.userId}/config`);
                    this.config = await response.json();
                } catch (error) {
                    console.error('è¼‰å…¥ç”¨æˆ¶é…ç½®å¤±æ•—:', error);
                    this.config = { trackingRules: [] };
                }
            }

            async saveConfig() {
                try {
                    const apiUrl = this.isLiffReady && this.currentUser 
                        ? `/api/users/${this.currentUser.userId}/config`
                        : '/api/config';
                        
                    await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.config)
                    });
                } catch (error) {
                    console.error('å„²å­˜é…ç½®å¤±æ•—:', error);
                    alert('å„²å­˜é…ç½®å¤±æ•—');
                }
            }

            updateUserInfo() {
                if (!this.currentUser) return;
                
                // åœ¨é é¢é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
                const statusBar = document.querySelector('.bg-white.shadow-sm.border-b .max-w-6xl > div');
                if (statusBar) {
                    const userInfo = document.createElement('div');
                    userInfo.className = 'flex items-center space-x-2 text-sm';
                    userInfo.innerHTML = `
                        <img src="${this.currentUser.pictureUrl}" alt="ç”¨æˆ¶é ­åƒ" class="w-6 h-6 rounded-full">
                        <span class="text-gray-600">æ­¡è¿ï¼Œ${this.currentUser.displayName}</span>
                    `;
                    statusBar.appendChild(userInfo);
                }
            }

            async checkStatus() {
                try {
                    const response = await fetch('/api/track/status');
                    const status = await response.json();
                    
                    const statusDot = document.getElementById('statusDot');
                    const statusText = document.getElementById('statusText');
                    
                    if (status.isTracking) {
                        statusDot.className = 'w-3 h-3 bg-green-400 rounded-full animate-pulse';
                        statusText.textContent = 'è¿½è¹¤ä¸­';
                        document.getElementById('startBtn').classList.add('hidden');
                        document.getElementById('stopBtn').classList.remove('hidden');
                    } else {
                        statusDot.className = 'w-3 h-3 bg-red-400 rounded-full';
                        statusText.textContent = 'æœªè¿½è¹¤';
                        document.getElementById('startBtn').classList.remove('hidden');
                        document.getElementById('stopBtn').classList.add('hidden');
                    }
                } catch (error) {
                    console.error('æª¢æŸ¥ç‹€æ…‹å¤±æ•—:', error);
                }
            }

            addRule(e) {
                e.preventDefault();
                
                // ç”Ÿæˆå”¯ä¸€çš„ ID
                const ruleId = 'rule_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const rule = {
                    id: ruleId,
                    name: document.getElementById('ruleName').value,
                    enabled: true,
                    filters: {
                        productType: document.getElementById('productType').value || undefined,
                        chip: document.getElementById('chip').value || undefined,
                        minMemory: document.getElementById('minMemory').value ? parseInt(document.getElementById('minMemory').value) : undefined,
                        color: document.getElementById('color').value || undefined,
                        maxPrice: document.getElementById('maxPrice').value ? parseInt(document.getElementById('maxPrice').value) : undefined
                    }
                };

                // æ¸…ç†ç©ºå€¼
                Object.keys(rule.filters).forEach(key => {
                    if (rule.filters[key] === undefined) {
                        delete rule.filters[key];
                    }
                });

                console.log('æ–°å¢è¦å‰‡:', rule);
                
                this.config.trackingRules.push(rule);
                this.saveConfig();
                this.updateUI();
                
                document.getElementById('ruleForm').reset();
            }

            deleteRule(ruleId) {
                console.log('åŸ·è¡Œåˆªé™¤è¦å‰‡:', ruleId);
                const originalLength = this.config.trackingRules.length;
                this.config.trackingRules = this.config.trackingRules.filter(rule => rule.id !== ruleId);
                
                if (this.config.trackingRules.length < originalLength) {
                    console.log('è¦å‰‡å·²åˆªé™¤');
                    this.saveConfig();
                    this.updateUI();
                } else {
                    console.error('æœªæ‰¾åˆ°è¦åˆªé™¤çš„è¦å‰‡:', ruleId);
                }
            }

            toggleRule(ruleId) {
                console.log('åŸ·è¡Œåˆ‡æ›è¦å‰‡:', ruleId);
                const rule = this.config.trackingRules.find(r => r.id === ruleId);
                if (rule) {
                    rule.enabled = !rule.enabled;
                    console.log('è¦å‰‡ç‹€æ…‹å·²åˆ‡æ›ç‚º:', rule.enabled);
                    this.saveConfig();
                    this.updateUI();
                } else {
                    console.error('æœªæ‰¾åˆ°è¦åˆ‡æ›çš„è¦å‰‡:', ruleId);
                }
            }

            updateUI() {
                document.getElementById('rulesCount').textContent = this.config.trackingRules.length;
                this.updateRulesList();
            }

            updateRulesList() {
                const container = document.getElementById('rulesList');
                
                if (this.config.trackingRules.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">ğŸ“</div>
                            <p>å°šæœªè¨­å®šè¿½è¹¤è¦å‰‡</p>
                            <p class="text-sm">è«‹å¡«å¯«ä¸Šæ–¹è¡¨å–®æ–°å¢æ‚¨çš„è¿½è¹¤æ¢ä»¶</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.config.trackingRules.map(rule => `
                    <div class="p-4 border rounded-lg ${rule.enabled ? 'border-blue-200 bg-blue-50' : 'border-gray-200 bg-gray-50'}" data-rule-id="${rule.id}">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-2 space-y-2 sm:space-y-0">
                            <h4 class="font-medium text-gray-900">${rule.name}</h4>
                            <div class="flex space-x-2 flex-shrink-0">
                                <button class="toggle-rule-btn px-3 py-1 text-xs rounded transition-colors ${rule.enabled ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}" 
                                        data-rule-id="${rule.id}">
                                    ${rule.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}
                                </button>
                                <button class="delete-rule-btn px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                        data-rule-id="${rule.id}">
                                    åˆªé™¤
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 break-words">${this.formatFilters(rule.filters)}</p>
                    </div>
                `).join('');
                
                // ç­‰å¾…DOMæ›´æ–°å¾Œç¶å®šäº‹ä»¶
                setTimeout(() => {
                    console.log('ç¶å®šæŒ‰éˆ•äº‹ä»¶...');
                    
                    // ç¶å®šåˆ‡æ›æŒ‰éˆ•äº‹ä»¶
                    const toggleBtns = container.querySelectorAll('.toggle-rule-btn');
                    console.log('æ‰¾åˆ°åˆ‡æ›æŒ‰éˆ•:', toggleBtns.length);
                    toggleBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // ç¢ºä¿ç²å–æ­£ç¢ºçš„å…ƒç´ å’Œ rule-id
                            const target = e.currentTarget; // ä½¿ç”¨ currentTarget è€Œä¸æ˜¯ target
                            const ruleId = target.getAttribute('data-rule-id');
                            console.log('åˆ‡æ›è¦å‰‡:', ruleId, 'target:', target);
                            
                            if (ruleId) {
                                this.toggleRule(ruleId);
                            } else {
                                console.error('ç„¡æ³•ç²å– rule-id');
                            }
                        });
                    });
                    
                    // ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
                    const deleteBtns = container.querySelectorAll('.delete-rule-btn');
                    console.log('æ‰¾åˆ°åˆªé™¤æŒ‰éˆ•:', deleteBtns.length);
                    deleteBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // ç¢ºä¿ç²å–æ­£ç¢ºçš„å…ƒç´ å’Œ rule-id
                            const target = e.currentTarget; // ä½¿ç”¨ currentTarget è€Œä¸æ˜¯ target
                            const ruleId = target.getAttribute('data-rule-id');
                            console.log('åˆªé™¤è¦å‰‡:', ruleId, 'target:', target);
                            
                            if (ruleId) {
                                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¿½è¹¤è¦å‰‡å—ï¼Ÿ')) {
                                    this.deleteRule(ruleId);
                                }
                            } else {
                                console.error('ç„¡æ³•ç²å– rule-id');
                            }
                        });
                    });
                }, 0);
            }

            formatFilters(filters) {
                const conditions = [];
                if (filters.productType) conditions.push(`ç”¢å“: ${filters.productType}`);
                if (filters.chip) conditions.push(`æ™¶ç‰‡: ${filters.chip}`);
                if (filters.minMemory) conditions.push(`è¨˜æ†¶é«”: â‰¥${filters.minMemory}GB`);
                if (filters.color) conditions.push(`é¡è‰²: ${filters.color}`);
                if (filters.maxPrice) conditions.push(`åƒ¹æ ¼: â‰¤NT$${filters.maxPrice.toLocaleString()}`);
                
                return conditions.length > 0 ? conditions.join(' | ') : 'ç„¡é™åˆ¶';
            }

            updateProductOptions(productType) {
                const chipSelect = document.getElementById('chip');
                const memorySelect = document.getElementById('minMemory');
                const colorSelect = document.getElementById('color');

                // é‡ç½®æ‰€æœ‰é¸é …
                chipSelect.innerHTML = '<option value="">ä¸é™</option>';
                memorySelect.innerHTML = '<option value="">ä¸é™</option>';
                colorSelect.innerHTML = '<option value="">ä¸é™</option>';

                if (!productType || !this.productSpecs[productType]) {
                    // å¦‚æœæ²’é¸ç”¢å“é¡å‹ï¼Œé¡¯ç¤ºæ‰€æœ‰é¸é …
                    ['M2', 'M2 Pro', 'M2 Max', 'M3', 'M3 Pro', 'M3 Max', 'M4', 'M4 Pro', 'M4 Max', 'M4 Ultra'].forEach(chip => {
                        chipSelect.innerHTML += `<option value="${chip}">${chip}</option>`;
                    });
                    [8, 16, 24, 32, 36, 64, 128, 192].forEach(memory => {
                        memorySelect.innerHTML += `<option value="${memory}">${memory}GB</option>`;
                    });
                    ['éŠ€è‰²', 'å¤ªç©ºç°è‰²', 'å¤ªç©ºé»‘è‰²', 'æ˜Ÿå…‰è‰²', 'åˆå¤œè‰²', 'å¤©è—è‰²', 'ç²‰ç´…è‰²'].forEach(color => {
                        colorSelect.innerHTML += `<option value="${color}">${color}</option>`;
                    });
                    return;
                }

                const specs = this.productSpecs[productType];

                // æ›´æ–°æ™¶ç‰‡é¸é …
                specs.chips.forEach(chip => {
                    chipSelect.innerHTML += `<option value="${chip}">${chip}</option>`;
                });

                // æ›´æ–°è¨˜æ†¶é«”é¸é …
                specs.memory.forEach(memory => {
                    memorySelect.innerHTML += `<option value="${memory}">${memory}GB</option>`;
                });

                // æ›´æ–°é¡è‰²é¸é …
                specs.colors.forEach(color => {
                    colorSelect.innerHTML += `<option value="${color}">${color}</option>`;
                });
            }

            async startTracking() {
                try {
                    const response = await fetch('/api/track/start', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.checkStatus();
                    } else {
                        alert(result.error || 'å•Ÿå‹•å¤±æ•—');
                    }
                } catch (error) {
                    console.error('å•Ÿå‹•è¿½è¹¤å¤±æ•—:', error);
                    alert('å•Ÿå‹•è¿½è¹¤å¤±æ•—');
                }
            }

            async stopTracking() {
                try {
                    const response = await fetch('/api/track/stop', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.checkStatus();
                    }
                } catch (error) {
                    console.error('åœæ­¢è¿½è¹¤å¤±æ•—:', error);
                    alert('åœæ­¢è¿½è¹¤å¤±æ•—');
                }
            }

            async testProducts() {
                const btn = document.getElementById('testBtn');
                const resultsDiv = document.getElementById('testResults');
                const productsDiv = document.getElementById('productsList');
                
                btn.disabled = true;
                btn.textContent = 'ğŸ”„ æ¸¬è©¦ä¸­...';
                
                resultsDiv.classList.remove('hidden');
                productsDiv.innerHTML = '<div class="text-center py-8 text-gray-500">æ­£åœ¨çˆ¬å–ç”¢å“è³‡æ–™ï¼Œè«‹ç¨å€™...</div>';
                
                try {
                    const response = await fetch('/api/products/test');
                    const result = await response.json();
                    
                    if (result.error) {
                        productsDiv.innerHTML = `<div class="text-center py-8 text-red-500">æ¸¬è©¦å¤±æ•—: ${result.error}</div>`;
                        return;
                    }
                    
                    let htmlContent = `
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-medium text-blue-900">${result.message}</h4>
                        </div>
                    `;
                    
                    // å¦‚æœæœ‰è¦å‰‡çµæœï¼Œé¡¯ç¤ºæ¯å€‹è¦å‰‡çš„åŒ¹é…æƒ…æ³
                    if (result.ruleResults && result.ruleResults.length > 0) {
                        htmlContent += '<div class="mb-6">';
                        htmlContent += '<h4 class="font-medium text-gray-900 mb-3">å„è¦å‰‡åŒ¹é…çµæœ:</h4>';
                        
                        result.ruleResults.forEach(ruleResult => {
                            const matchText = ruleResult.matchCount > 0 ? 
                                `âœ… æ‰¾åˆ° ${ruleResult.matchCount} å€‹åŒ¹é…ç”¢å“` : 
                                'âŒ æ²’æœ‰åŒ¹é…çš„ç”¢å“';
                            
                            htmlContent += `
                                <div class="mb-3 p-3 border rounded-lg ${ruleResult.matchCount > 0 ? 'border-green-200 bg-green-50' : 'border-gray-200 bg-gray-50'}">
                                    <div class="font-medium">${ruleResult.ruleName}</div>
                                    <div class="text-sm text-gray-600">${matchText}</div>
                                </div>
                            `;
                        });
                        htmlContent += '</div>';
                    }
                    
                    // é¡¯ç¤ºç”¢å“åˆ—è¡¨
                    const products = result.products || result.summary || [];
                    if (products.length === 0) {
                        htmlContent += '<div class="text-center py-8 text-gray-500">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç”¢å“</div>';
                    } else {
                        htmlContent += '<h4 class="font-medium text-gray-900 mb-3">ç”¢å“åˆ—è¡¨:</h4>';
                        htmlContent += products.map(product => `
                            <div class="flex flex-col sm:flex-row p-3 sm:p-4 border rounded-lg bg-gray-50 space-y-3 sm:space-y-0 mb-3">
                                <img src="${product.image || ''}" alt="${product.name}" 
                                     class="w-full h-32 sm:w-16 sm:h-16 rounded object-cover sm:mr-4 bg-gray-200 flex-shrink-0" 
                                     onerror="this.style.display='none'">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-gray-900 mb-1 text-sm sm:text-base break-words">
                                        ${product.url ? `<a href="${product.url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">${product.name}</a>` : product.name}
                                    </h4>
                                    <p class="text-base sm:text-lg font-semibold text-green-600 mb-1">${product.price || 'åƒ¹æ ¼æœªçŸ¥'}</p>
                                    <p class="text-xs sm:text-sm text-gray-600 break-words">${this.formatSpecs(product.specs)}</p>
                                    ${product.url ? '<p class="text-xs text-blue-500 mt-1">ğŸ”— é»æ“Šç”¢å“åç¨±æŸ¥çœ‹è©³æƒ…</p>' : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    productsDiv.innerHTML = htmlContent;
                    
                } catch (error) {
                    console.error('æ¸¬è©¦å¤±æ•—:', error);
                    productsDiv.innerHTML = '<div class="text-center py-8 text-red-500">æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>';
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ§ª æ¸¬è©¦çˆ¬å–';
                }
            }

            formatSpecs(specs) {
                const specParts = [];
                if (specs.productType) specParts.push(specs.productType);
                if (specs.chip) specParts.push(specs.chip);
                if (specs.memory) specParts.push(specs.memory);
                if (specs.storage) specParts.push(specs.storage);
                if (specs.color) specParts.push(specs.color);
                
                return specParts.join(' | ') || 'è¦æ ¼æœªçŸ¥';
            }
        }

        const app = new AppleTrackerUI();
    </script>
</body>
</html>